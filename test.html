<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
<img lazyload class="new-con-brand-img" data-src="{$coupon.coupon_img}" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="{$coupon.title}">
<script>
    var viewHeight = document.documentElement.clientHeight; // 获取视口高度
    /** 实现懒加载效果的方法
     * 获取需要懒加载的元素组成名为「else」的类数组（该元素为包含 'data-src' 和 'lazyload' 属性的 img 标签）
     * 将类数组转化为数组后遍历该数组
     * 若该元素不存在「src」属性或样式「display」属性为'none'时退出此次循环
     * 否则继续执行
     * 获取该元素的位置
     * 当图片出现在可视区域时立刻执行下列函数
     *    声明「img」标签
     *    将 data-src 的属性赋值给 src
     *    将「src」属性赋值给 image 图片
     *    在图片加载完成之后将 img 的「src」属性重新赋值给当前元素的「src」属性
     *    去除当前元素data-src和lazyload属性
     *    图片正常加载并显示
     */
    function lazyload() {
        var eles = document.querySelectorAll('img[data-src][lazyload]');
        
        Array.prototype.forEach.call(eles, function (item, index) {
            var rect;
            
            if (item.dataset.src === '' || window.getComputedStyle(item, null).display == 'none')
                return;
            rect = item.getBoundingClientRect();

            if (rect.bottom >= 0 && rect.top < viewHeight) {
                ! function () {
                    var img = new Image();
                    img.src = item.dataset.src;
                    img.onload = function () {
                        item.src = img.src;
                    }
                    item.removeAttribute('data-src');
                    item.removeAttribute('lazyload');
                }();
            }
        })
    }
    // 立刻执行懒加载方法
    // 监听页面滑动事件并执行懒加载函数
    lazyload();
    document.addEventListener('scroll', lazyload);
</script>

<script>
    function check_webp_feature(feature, callback) {
        var kTestImages = {
            lossy: "UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",
            lossless: "UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==",
            alpha: "UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",
            animation: "UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA"
        };
        var img = new Image();
        img.onload = function () {
            var result = (img.width > 0) && (img.height > 0);
            callback(feature, result);
        };
        img.onerror = function () {
            callback(feature, false);
        };
        img.src = "data:image/webp;base64," + kTestImages[feature];
    }
    check_webp_feature('lossy', (f, r) => {
        var viewHeight = document.documentElement.clientHeight;
        function lazyload() {
            var eles = document.querySelectorAll('img[data-src]');
            Array.prototype.forEach.call(eles, function (item, index) {
                var rect;
                if (item.dataset.src === '' || window.getComputedStyle(item, null).display == 'none') {
                    return;
                }
                rect = item.getBoundingClientRect();
                if (rect.bottom >= 0 && rect.top < viewHeight) {
                    !function () {
                        var img = new Image();
                        if (r && item.dataset.webpsrc) {
                            img.src = item.dataset.webpsrc;
                        } else {
                            img.src = item.dataset.src;
                        }
                        img.onload = function () {
                            item.src = img.src;
                        }
                        item.removeAttribute('data-webpsrc');
                        item.removeAttribute('data-src');
                    }();
                }
            })
        }

        lazyload();
        document.addEventListener('scroll', lazyload);
    })
</script>
</body>
</html>